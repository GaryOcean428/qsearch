<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>qsearch</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
      header { padding: 16px 20px; border-bottom: 1px solid rgba(127,127,127,0.25); }
      main { max-width: 980px; margin: 0 auto; padding: 20px; }
      .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      input[type=text] { flex: 1 1 420px; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(127,127,127,0.35); }
      input[type=number] { width: 90px; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(127,127,127,0.35); }
      button { padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(127,127,127,0.35); cursor: pointer; }
      .meta { margin-top: 10px; opacity: 0.8; font-size: 13px; }
      .results { margin-top: 18px; display: grid; gap: 10px; }
      .card { padding: 14px; border-radius: 12px; border: 1px solid rgba(127,127,127,0.25); }
      .title { font-weight: 700; margin-bottom: 6px; }
      .url { font-size: 12px; opacity: 0.8; word-break: break-all; }
      .snippet { margin-top: 10px; font-size: 14px; line-height: 1.4; }
      .badge { display: inline-block; font-size: 12px; padding: 3px 8px; border-radius: 999px; border: 1px solid rgba(127,127,127,0.35); margin-left: 8px; }
    </style>
  </head>
  <body>
    <header>
      <div class="row">
        <div style="font-weight:800">qsearch</div>
        <div style="opacity:.75">Scrapy crawl → basin index → geometric ranking</div>
      </div>
    </header>
    <main>
      <div class="row">
        <input id="q" type="text" placeholder="Search…" />
        <input id="limit" type="number" min="1" max="50" value="10" />
        <button id="go">Search</button>
      </div>
      <div class="meta" id="meta"></div>
      <div class="results" id="results"></div>

      <script>
        const qEl = document.getElementById('q');
        const limitEl = document.getElementById('limit');
        const goEl = document.getElementById('go');
        const metaEl = document.getElementById('meta');
        const resultsEl = document.getElementById('results');

        async function doSearch() {
          const query = qEl.value.trim();
          const limit = Number(limitEl.value || 10);
          if (!query) return;

          metaEl.textContent = 'Searching…';
          resultsEl.innerHTML = '';

          const t0 = performance.now();
          const res = await fetch('/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query, limit })
          });

          const data = await res.json();
          const dt = Math.round(performance.now() - t0);

          if (!res.ok) {
            metaEl.textContent = `Error (${res.status}): ${JSON.stringify(data)}`;
            return;
          }

          const hit = data.cache_hit ? 'cache' : 'compute';
          metaEl.textContent = `${data.count} results • ${dt}ms • ${hit}`;

          for (const r of data.results) {
            const card = document.createElement('div');
            card.className = 'card';

            const title = document.createElement('div');
            title.className = 'title';
            title.textContent = r.title || '(untitled)';

            const badge = document.createElement('span');
            badge.className = 'badge';
            badge.textContent = `d=${Number(r.distance).toFixed(4)}`;
            title.appendChild(badge);

            const url = document.createElement('div');
            url.className = 'url';
            url.innerHTML = `<a href="${r.url}" target="_blank" rel="noreferrer">${r.url}</a>`;

            const snippet = document.createElement('div');
            snippet.className = 'snippet';
            snippet.textContent = r.snippet || '';

            card.appendChild(title);
            card.appendChild(url);
            card.appendChild(snippet);
            resultsEl.appendChild(card);
          }
        }

        goEl.addEventListener('click', doSearch);
        qEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); });
      </script>
    </main>
  </body>
</html>
